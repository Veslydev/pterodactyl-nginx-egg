# Optimized nginx configuration
server {
    listen 80;
    server_name "";

    # Optimized logging
    access_log /home/container/logs/naccess.log combined buffer=256k flush=5s;
    error_log  /home/container/logs/nerror.log warn;

    # Document root and index files
    root /home/container/www;
    index index.php index.html index.htm;
    charset utf-8;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;

    # Performance optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    client_max_body_size 100m;
    client_body_timeout 60s;
    client_header_timeout 60s;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/js
        text/xml
        text/javascript
        application/javascript
        application/json
        application/xml
        application/rss+xml
        application/atom+xml
        image/svg+xml;

    # Static files caching
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        try_files $uri =404;
    }

    # Common static files
    location = /favicon.ico { 
        access_log off; 
        log_not_found off; 
        expires 1y;
        add_header Cache-Control "public";
    }
    
    location = /robots.txt  { 
        access_log off; 
        log_not_found off; 
        expires 1d;
        add_header Cache-Control "public";
    }

    # Main location block
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    # Optimized PHP handling
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/home/container/tmp/php-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PHP_VALUE "upload_max_filesize = 1024M \n post_max_size=1024M \n memory_limit=256M \n max_execution_time=300";
        fastcgi_param HTTP_PROXY "";
        include fastcgi_params;
        
        # Optimized FastCGI settings
        fastcgi_intercept_errors on;
        fastcgi_buffer_size 32k;
        fastcgi_buffers 8 32k;
        fastcgi_busy_buffers_size 64k;
        fastcgi_temp_file_write_size 64k;
        fastcgi_connect_timeout 60;
        fastcgi_send_timeout 300;
        fastcgi_read_timeout 300;
    }

    # Security - Block access to sensitive files
    location ~ /\.(git|svn|htaccess|htpasswd) {
        deny all;
        return 404;
    }

    location ~ /\.ht {
        deny all;
        return 404;
    }

    # Block access to configuration files
    location ~* \.(conf|cnf|sql|sh|key)$ {
        deny all;
        return 404;
    }

    # Custom error pages
    error_page 404 /404;
    error_page 403 /404;
    error_page 500 502 503 504 /50x.html;
    # Optimized URL rewrites - Special routes first
    rewrite ^/robots\.txt(/?)$ /robots.php last;
    rewrite ^/sitemap\.xml(/?)$ /sitemap.php last;
    
    # Payment callbacks (high priority)
    rewrite ^/(odeme|payment)/callback/([0-9a-zA-Z-_]+)(/?)$ /main/includes/packages/payments/callback.php?paymentAPI=$2 last;
    rewrite ^/(odeme|payment)/paytr/([0-9a-zA-Z-_]+)(/?)$ /main/index.php?page=credit&action=paytr&paymentID=$2 last;
    rewrite ^/(odeme|payment)/shopier/([0-9a-zA-Z-_]+)(/?)$ /main/index.php?page=credit&action=shopier&paymentID=$2 last;
    
    # Discord routes
    rewrite ^/discord/role(/?)$ /main/includes/packages/layouts/discord/php/proccess.php?action=role last;
    rewrite ^/discord/login(/?)$ /main/includes/packages/layouts/discord/php/proccess.php?action=login last;
    rewrite ^/discord(/?)$ /main/index.php?page=discord last;

    # Core pages
    rewrite ^/(/?)$ /main/index.php?page=home last;
    rewrite ^/(anasayfa|home)(/?)$ /main/index.php?page=home last;
    rewrite ^/(kurulum|install)(/?)$ /install/includes/php/install.php last;
    rewrite ^/404(/?)$ /main/index.php?page=404 last;
    rewrite ^/(bakim|maintance)(/?)$ /main/index.php?page=maintance last;
    # Lottery and voting
    rewrite ^/(piyango|lottery)(/?)$ /main/index.php?page=lottery last;
    rewrite ^/(oy|vote)(/?)$ /main/index.php?page=vote last;

    # Forum routes (grouped for better performance)
    rewrite ^/(forum|forum)(/?)$ /main/index.php?page=forum&action=topic last;
    rewrite ^/(forum|forum)/([0-9a-zA-Z-_]+)/([0-9]+)(/?)$ /main/index.php?page=forum&action=topic&categoryID=$3 last;
    rewrite ^/(forum|forum)/([0-9a-zA-Z-_]+)/([0-9a-zA-Z-_]+)/([0-9]+)(/?)$ /main/index.php?page=forum&action=topic&topicID=$4 last;
    rewrite ^/(forum|forum)/(konu|topic)/(olustur|create)(/?)$ /main/index.php?page=forum&action=proccess&proccess=create last;
    rewrite ^/(forum|forum)/(konu|topic)/(olustur|create)/([0-9a-zA-Z-_]+)/([0-9]+)(/?)$ /main/index.php?page=forum&action=proccess&proccess=create&categoryID=$5 last;
    rewrite ^/(forum|forum)/(konu|topic)/(duzenle|edit)/([0-9a-zA-Z-_]+)/([0-9]+)(/?)$ /main/index.php?page=forum&action=proccess&proccess=edit&target=topic&topicID=$5 last;
    rewrite ^/(forum|forum)/(konu|topic)/(mesaj|message)/(duzenle|edit)/([0-9]+)(/?)$ /main/index.php?page=forum&action=proccess&proccess=edit&target=message&messageID=$5 last;

    # News and blog routes
    rewrite ^/(haber|blog)/([0-9a-zA-Z-_]+)/([0-9]+)(/?)$ /main/index.php?page=blog&news=$3 last;
    rewrite ^/(haberler|news)/([0-9]+)(/?)$ /main/index.php?page=home&news=$2 last;
    rewrite ^/(haberler|news)/(kategori|category)/([0-9a-zA-Z-_]+)(/?)$ /main/index.php?page=news&action=category&category=$3 last;

    # Static pages and core functionality
    rewrite ^/([0-9a-zA-Z-_]+)/([0-9]+)(/?)$ /main/index.php?page=pages&pages=$2 last;
    rewrite ^/(basvuru|apps)(/?)$ /main/index.php?page=applications last;
    rewrite ^/(basvuru|apps)/([0-9a-zA-Z-_]+)/([0-9]+)(/?)$ /main/index.php?page=applications&appID=$3 last;
    rewrite ^/(kurallar|rules)(/?)$ /main/index.php?page=rules last;
    rewrite ^/(gizlilik-sozlesmesi|privacy-policy)(/?)$ /main/index.php?page=privacy last;
    rewrite ^/(hakkimizda|about-us)(/?)$ /main/index.php?page=abouts last;
    rewrite ^/(satis-sozlesmesi|sales-agreement)(/?)$ /main/index.php?page=toc last;
    rewrite ^/(yasaklananlar|banned)(/?)$ /main/index.php?page=bans last;

    # Authentication routes
    rewrite ^/(kayit-ol|register)(/?)$ /main/index.php?page=register last;
    rewrite ^/(giris-yap|login)(/?)$ /main/index.php?page=login last;
    rewrite ^/(cikis-yap|logout)(/?)$ /main/index.php?page=exit last;
    rewrite ^/(sifremi-unuttum|recovery)(/?)$ /main/index.php?page=recovery last;
    rewrite ^/(sifremi-unuttum|recovery)/([0-9a-zA-Z-_]+)(/?)$ /main/index.php?page=recovery&token=$2 last;

    # Player-related routes
    rewrite ^/(oyuncu|player)(/?)$ /main/index.php?page=player last;
    rewrite ^/(oyuncu|player)/([0-9a-zA-Z-_]+)(/?)$ /main/index.php?page=player&action=info&player=$2 last;
    rewrite ^/(oyuncu|player)/([0-9a-zA-Z-_]+)/(mesajlar|messages)(/?)$ /main/index.php?page=player&action=message&player=$2 last;

    # Inventory and game features
    rewrite ^/(sandik|chest)(/?)$ /main/index.php?page=chest last;
    rewrite ^/(envanter|inventory)(/?)$ /main/index.php?page=inventory last;
    rewrite ^/(hediye-kuponu|gift-coupon)(/?)$ /main/index.php?page=coupon last;

    # Store routes (most complex, grouped for performance)
    rewrite ^/(magaza|store)(/?)$ /main/index.php?page=store last;
    rewrite ^/(magaza|store)/([0-9a-zA-Z-_]+)/([0-9]+)(/?)$ /main/index.php?page=store&serverID=$3 last;
    rewrite ^/(magaza|store)/([0-9a-zA-Z-_]+)/([0-9a-zA-Z-_]+)/([0-9]+)(/?)$ /main/index.php?page=store&categoryID=$4 last;
    rewrite ^/(magaza|store)/([0-9a-zA-Z-_]+)/([0-9a-zA-Z-_]+)/([0-9a-zA-Z-_]+)/([0-9]+)(/?)$ /main/index.php?page=store&productID=$5 last;
    rewrite ^/(sepet|cart)(/?)$ /main/index.php?page=shopping-cart last;

    # Support routes
    rewrite ^/(yardim-merkezi|help-center)(/?)$ /main/index.php?page=help-center last;
    rewrite ^/(destek|support)(/?)$ /main/index.php?page=support&action=get last;
    rewrite ^/(destek|support)/(olustur|create)(/?)$ /main/index.php?page=support&action=create last;
    rewrite ^/(destek|support)/([0-9a-zA-Z-_]+)/([0-9]+)(/?)$ /main/index.php?page=support&action=update&id=$3 last;
    # Credit and payment routes
    rewrite ^/(kredi|credit)/(yukle|buy)(/?)$ /main/index.php?page=credit&action=proccess last;
    rewrite ^/(kredi|credit)/(yukle|buy)/(basarili|success)(/?)$ /main/index.php?page=credit&action=transactions&target=successyfull last;
    rewrite ^/(kredi|credit)/(yukle|buy)/(basarisiz|fail)(/?)$ /main/index.php?page=credit&action=transactions&target=unsuccessyfull last;
    rewrite ^/(kredi|credit)/(gonder|send)(/?)$ /main/index.php?page=credit&action=transfer last;

    # Card game routes
    rewrite ^/(kart-oyunu|card-game)(/?)$ /main/index.php?page=card last;
    rewrite ^/(kart-oyunu|card-game)/([0-9a-zA-Z-_]+)/([0-9]+)(/?)$ /main/index.php?page=card&id=$3 last;
    # Profile routes (grouped for better performance)
    rewrite ^/(profil|profile)(/?)$ /main/index.php?page=profile&action=profile&proccess=profile last;
    rewrite ^/(profil|profile)/(mesajlar|message)(/?)$ /main/index.php?page=profile&action=profile&proccess=message last;
    rewrite ^/(profil|profile)/(bildirimler|notifications)(/?)$ /main/index.php?page=profile&action=profile&proccess=notifications last;
    rewrite ^/(profil|profile)/(duzenle|edit)(/?)$ /main/index.php?page=profile&action=account&proccess=change last;
    rewrite ^/(profil|profile)/(sifremi-degistir|password-change)(/?)$ /main/index.php?page=profile&action=account&proccess=password last;
    rewrite ^/(profil|profile)/(ayarlar|settings)(/?)$ /main/index.php?page=profile&action=account&proccess=settings last;
    
    # Profile history routes
    rewrite ^/(profil|profile)/(gecmis|history)/(sandik|chest)(/?)$ /main/index.php?page=profile&action=history&proccess=chest last;
    rewrite ^/(profil|profile)/(gecmis|history)/(magaza|store)(/?)$ /main/index.php?page=profile&action=history&proccess=store last;
    rewrite ^/(profil|profile)/(gecmis|history)/(kredi|credit)(/?)$ /main/index.php?page=profile&action=history&proccess=credit last;
    rewrite ^/(profil|profile)/(gecmis|history)/(kart-oyunu|card-game)(/?)$ /main/index.php?page=profile&action=history&proccess=card last;
    rewrite ^/(profil|profile)/(gecmis|history)/(hediye-kuponu|gift-coupon)(/?)$ /main/index.php?page=profile&action=history&proccess=coupon last;
    rewrite ^/(profil|profile)/(gecmis|history)/(engel|ban)(/?)$ /main/index.php?page=profile&action=history&proccess=banned last;
    # Admin routes (optimized and grouped)
    # Admin core
    rewrite ^/admin(/?)$ /admin/index.php?page=home last;
    rewrite ^/admin/(anasayfa|home)(/?)$ /admin/index.php?page=home last;
    rewrite ^/admin/(anasayfa|home)/perm-error(/?)$ /admin/index.php?page=home&action=perm-error last;
    rewrite ^/admin/404(/?)$ /admin/index.php?page=404 last;
    rewrite ^/admin/(guncellemeler|updates)(/?)$ /admin/index.php?page=updates last;
    
    # Admin statistics
    rewrite ^/admin/(istatistikler|statistics)(/?)$ /admin/index.php?page=home&action=statistics&stats=overview last;
    rewrite ^/admin/(istatistikler|statistics)/(genel|overview)(/?)$ /admin/index.php?page=home&action=statistics&stats=overview last;
    rewrite ^/admin/(istatistikler|statistics)/(aylik-rapor|monthly-report)(/?)$ /admin/index.php?page=home&action=statistics&stats=report last;
    rewrite ^/admin/(istatistikler|statistics)/(odemeler|payments)(/?)$ /admin/index.php?page=home&action=statistics&stats=payments last;

    # Admin store management (key routes only)
    rewrite ^/admin/(magaza|store)/(sunucu|server)(/?)$ /admin/index.php?page=store&action=server&target=update last;
    rewrite ^/admin/(magaza|store)/(sunucu|server)/(ekle|add)(/?)$ /admin/index.php?page=store&action=server&target=add last;
    rewrite ^/admin/(magaza|store)/(sunucu|server)/([0-9]+)(/?)$ /admin/index.php?page=store&action=server&target=update&serverID=$3 last;
    rewrite ^/admin/(magaza|store)/(kategori|category)(/?)$ /admin/index.php?page=store&action=category&target=update last;
    rewrite ^/admin/(magaza|store)/(kategori|category)/(ekle|add)(/?)$ /admin/index.php?page=store&action=category&target=add last;
    rewrite ^/admin/(magaza|store)/(urun|product)(/?)$ /admin/index.php?page=store&action=product&target=update last;
    rewrite ^/admin/(magaza|store)/(urun|product)/(ekle|add)(/?)$ /admin/index.php?page=store&action=product&target=add last;
    
    # Admin players management
    rewrite ^/admin/(oyuncular|players)(/?)$ /admin/index.php?page=player&action=account&target=player last;
    rewrite ^/admin/(oyuncu|player)/(ekle|add)(/?)$ /admin/index.php?page=player&action=account&target=create last;
    rewrite ^/admin/(oyuncular|players)/([0-9a-zA-Z-_]+)(/?)$ /admin/index.php?page=player&action=account&target=player&proccess=all&username=$2 last;
    
    # Admin general management
    rewrite ^/admin/(genel|general)/(haber|news)(/?)$ /admin/index.php?page=general&action=news&target=update last;
    rewrite ^/admin/(genel|general)/(haber|news)/(ekle|add)(/?)$ /admin/index.php?page=general&action=news&target=add last;
    rewrite ^/admin/(ayarlar|settings)/(genel-ayarlar|general-settings)(/?)$ /admin/index.php?page=settings&action=general last;
    
    # Catch-all for remaining admin routes (with parameter matching)
    rewrite "^/admin/([^/]+)/([^/]+)/([^/]+)/([^/]+)/([0-9]+)(/?)$" /admin/index.php?page=$1&action=$2&target=$3&param1=$4&param2=$5 last;
    rewrite "^/admin/([^/]+)/([^/]+)/([^/]+)/([0-9]+)(/?)$" /admin/index.php?page=$1&action=$2&target=$3&param1=$4 last;
    rewrite "^/admin/([^/]+)/([^/]+)/([^/]+)(/?)$" /admin/index.php?page=$1&action=$2&target=$3 last;
    rewrite "^/admin/([^/]+)/([^/]+)(/?)$" /admin/index.php?page=$1&action=$2 last;
}
